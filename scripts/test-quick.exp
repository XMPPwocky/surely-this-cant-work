#!/usr/bin/expect -f
# Run the rvOS quick test suite (no child spawning, no test.img).
# Usage: expect scripts/test-quick.exp

set timeout 60
log_user 1

cd [file dirname [file dirname [file normalize [info script]]]]

spawn make run-quick

# Wait for the serial shell prompt (may have timer ticks interleaved)
expect {
    "rvos>" {}
    timeout { puts "TIMEOUT waiting for shell prompt"; exit 1 }
}

# Give a moment for any remaining boot output
sleep 1

send "run /bin/ktest --quick\r"

# Wait for test completion marker
expect {
    "=== ALL TESTS PASSED ===" {
        # Wait for shell prompt, then shut down
        expect {
            "rvos>" {}
            timeout {}
        }
        send "shutdown\r"
        expect eof
        exit 0
    }
    "=== SOME TESTS FAILED ===" {
        expect {
            "rvos>" {}
            timeout {}
        }
        send "shutdown\r"
        expect eof
        exit 1
    }
    timeout { puts "TIMEOUT waiting for tests"; exit 1 }
}
